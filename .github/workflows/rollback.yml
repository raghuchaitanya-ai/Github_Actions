name: rollback

on:
  workflow_dispatch: # Manual trigger only for safety

jobs:
  rollback-dev:
    name: Rollback Dev Sandbox
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history so we can go back to previous commits

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to DevSandbox
        run: |
          echo "${{ secrets.DEV_SF_AUTH_URL }}" | sf auth:sfdxurl:store --alias DevSandbox --sfdx-url-stdin

      - name: 1. Revert to Previous Commit
        # This points the local files to exactly how they were one commit ago
        run: |
          git checkout HEAD~1
          echo "Current commit is now: $(git rev-parse HEAD)"

      - name: 2. Deploy Stable Metadata
        # Deploys the reverted "stable" code back to the Sandbox
        run: |
          sf project deploy start --source-dir force-app/main/default --target-org DevSandbox --wait 10 --ignore-conflicts