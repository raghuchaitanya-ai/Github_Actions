name: Salesforce CI Pipeline (QA Baseline → Scratch → Dev)

on:
  push:
    branches:
      - dev

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      # 1. Environment Preparation
      - name: Checkout Current Branch (dev)
        uses: actions/checkout@v4
        with:
          path: current-branch

      - name: Checkout QA Branch (Baseline)
        uses: actions/checkout@v4
        with:
          ref: qa
          path: qa-branch

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      # 2. Scratch Org Validation Gate
      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store --alias DevHub_Git --sfdx-url-stdin --set-default-dev-hub

      # FIXED: Changed --target-org to --target-dev-hub to specify the hub org
      - name: Create Scratch Org
        run: |
          sf org create scratch \
            --definition-file current-branch/config/project-scratch-def.json \
            --target-dev-hub DevHub_Git \
            --alias ValidationOrg \
            --duration-days 1 \
            --wait 20

      - name: Deploy QA Baseline to Scratch
        run: |
          cd qa-branch
          sf project deploy start --source-dir force-app --target-org ValidationOrg --test-level NoTestRun --wait 15

      - name: Deploy Current Changes to Scratch
        run: |
          cd current-branch
          sf project deploy start --source-dir force-app --target-org ValidationOrg --test-level NoTestRun --wait 15

      # 3. Dynamic Deployment to Dev Sandbox
      - name: Check for Apex Changes (Logic Gate)
        id: check_apex
        run: |
          count=$(find current-branch/force-app -name "*.cls" | wc -l || echo 0)
          if [ "$count" -gt 0 ]; then
            echo "TEST_LEVEL=RunLocalTests" >> $GITHUB_ENV
          else
            echo "TEST_LEVEL=NoTestRun" >> $GITHUB_ENV
          fi

      - name: Authenticate & Deploy to Dev
        run: |
          echo "${{ secrets.DEV_SF_AUTH_URL }}" | sf auth:sfdxurl:store --alias DevSandbox_Git --sfdx-url-stdin
          cd current-branch
          sf project deploy start --source-dir force-app --target-org DevSandbox_Git --test-level ${{ env.TEST_LEVEL }} --wait 30

      # 4. Documentation & PR to QA
      - name: Open Pull Request to QA
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base qa \
            --head dev \
            --title "Release to qa: ${{ github.event.head_commit.message }}" \
            --body "Automated PR created after deploying into Dev Sandbox." || echo "PR already exists"

      # 5. Cleanup
      - name: Delete Scratch Org
        if: always()
        run: sf org delete scratch --target-org ValidationOrg --no-prompt || echo "Cleanup skipped"