name: ci-pipeline

on:
  push:
    branches:
      - dev

jobs:
  # 1) Static Code Analysis (PMD)
  static-code-analysis:
    name: Static Code Analysis (PMD)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Install PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases/7.16.0/pmd-dist-7.16.0-bin.zip
          unzip pmd-dist-7.16.0-bin.zip
          mv pmd-bin-7.16.0 pmd

      - name: Run PMD Analysis
        run: |
          ./pmd/bin/pmd check \
            -d force-app/main/default/classes \
            -R rulesets/apex/quickstart.xml \
            -f text \
            -r pmd-report.txt \
            --no-fail-on-violation

      - name: Email PMD Report to Developer
        uses: Padmachilaka/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "PMD Static Code Analysis Completed - ${{ github.ref_name }}"
          to: padduja712@gmail.com
          from: ci-cd@yourcompany.com
          body: |
            Static Code Analysis (PMD) has completed for branch: ${{ github.ref_name }}.
            Please review the PMD report in the workflow artifacts.
            Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Enforce PMD Quality Gate
        run: |
          violations=$(grep -c "^[^ ]" pmd-report.txt || true)
          echo "Total Violations Found: $violations"
          if [ "$violations" -gt 5 ]; then
            echo "PMD Quality Gate Failed. Too many violations."
            exit 1
          else
            echo "PMD Quality Gate Passed."
          fi

  # 2) Apex Tests (only if PMD passed)
  apex-tests:
    name: Salesforce Apex Tests
    runs-on: ubuntu-latest
    needs: static-code-analysis

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to Dev Sandbox
        run: echo "${{ secrets.DEV_SF_AUTH_URL }}" | sf auth:sfdxurl:store --alias DevSandbox --sfdx-url-stdin

      - name: Run Apex Tests
        run: sf apex run test --target-org DevSandbox --result-format human --code-coverage --wait 10

  # 3) Validation (only if Apex tests passed)
  validation:
    name: Salesforce Validation
    runs-on: ubuntu-latest
    needs: apex-tests

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to DevHub
        run: echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store --alias DevHub --set-default-dev-hub --sfdx-url-stdin

      - name: Create Scratch Org
        run: sf org create scratch --definition-file config/project-scratch-def.json --alias CI --set-default --duration-days 1 --target-dev-hub DevHub

      - name: Deploy to Scratch Org
        run: sf project deploy start --source-dir force-app --target-org CI --test-level RunLocalTests --wait 10

      - name: Validate Deployment (CheckOnly)
        run: sf project deploy start --source-dir force-app --target-org CI --dry-run --test-level RunLocalTests

      - name: Delete Scratch Org
        run: sf org delete scratch --target-org CI --no-prompt || true

  # 4) Deploy to Dev (only if Validation passed)
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: validation

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to Dev Sandbox
        run: echo "${{ secrets.DEV_SF_AUTH_URL }}" | sf auth:sfdxurl:store --alias DevSandbox --sfdx-url-stdin

      - name: Deploy Metadata to Dev
        run: sf project deploy start --source-dir force-app/main/default --target-org DevSandbox --test-level RunLocalTests --wait 10

  # 5) Failure Notification (if any job fails)
  notify-on-failure:
    name: Failure Notification
    runs-on: ubuntu-latest
    needs:
      - static-code-analysis
      - apex-tests
      - validation
      - deploy-dev
    if: ${{ failure() }}

    steps:
      - name: Send Failure Email Notification
        uses: Padmachilaka/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: " Dev CI Pipeline Failed - ${{ github.ref_name }}"
          to: padduja712@gmail.com
          from: ci-cd@yourcompany.com
          body: |
            One or more steps in the Dev CI Pipeline failed.
            Branch: ${{ github.ref_name }}
            Please review the failed job in GitHub Actions.
            Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}