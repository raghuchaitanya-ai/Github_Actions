name: Manual Scratch Org Validation

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Select branch to validate (QA baseline is applied first)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - uat

jobs:
  validate-scratch:
    runs-on: ubuntu-latest
    steps:
      # 1. Setup Directories
      - name: Checkout Target Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}
          path: current-branch

      - name: Checkout QA Baseline
        uses: actions/checkout@v4
        with:
          ref: qa
          path: qa-branch

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store \
            --alias DevHub_Git --sfdx-url-stdin --set-default-dev-hub

      # 2. Scratch Org Creation
      - name: Create Scratch Org
        run: |
          sf org create scratch \
            --definition-file current-branch/config/project-scratch-def.json \
            --target-dev-hub DevHub_Git \
            --alias ValidationOrg \
            --duration-days 1 --wait 20

      # 3. Get Credentials (Moved up so you don't lose the org if deployment fails)
      - name: Generate Org Credentials
        if: always() # Runs even if creation partially failed
        run: |
          sf org generate password --target-org ValidationOrg
          sf org display --target-org ValidationOrg --verbose

      # 4. Deployments
      - name: Deploy QA Baseline
        run: |
          sf project deploy start \
            --source-dir qa-branch/force-app \
            --target-org ValidationOrg \
            --ignore-conflicts \
            --wait 15

      - name: Deploy Selected Branch (Overlay)
        run: |
          sf project deploy start \
            --source-dir current-branch/force-app \
            --target-org ValidationOrg \
            --ignore-conflicts \
            --wait 15