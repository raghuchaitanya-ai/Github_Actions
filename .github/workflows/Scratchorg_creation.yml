name: Manual Scratch Org Validation

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to use as basis (usually QA)'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - uat

jobs:
  create-and-setup:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the QA branch (The Baseline)
      - name: Checkout QA Baseline
        uses: actions/checkout@v4
        with:
          ref: qa
          path: qa-branch

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store \
            --alias DevHub_Git --sfdx-url-stdin --set-default-dev-hub

      # 2. Create the Scratch Org
      - name: Create Scratch Org
        run: |
          sf org create scratch \
            --definition-file qa-branch/config/project-scratch-def.json \
            --alias ValidationOrg \
            --duration-days 1 --wait 20

      # 3. Deploy QA Code (The Baseline)
      # This ensures the org has everything currently in QA
      - name: Deploy QA Baseline to Org
        run: |
          sf project deploy start \
            --source-dir qa-branch/force-app \
            --target-org ValidationOrg \
            --ignore-conflicts

      # 4. Generate Credentials (DO THIS LAST)
      # This provides the URL you need to authorize in VS Code
      - name: Final Credentials for VS Code
        if: always()
        run: |
          sf org generate password --target-org ValidationOrg
          echo "### Scratch Org Details" >> $GITHUB_STEP_SUMMARY
          echo "Use the 'Sfdx Auth URL' below to log in via VS Code:" >> $GITHUB_STEP_SUMMARY
          sf org display --target-org ValidationOrg --verbose
