name: Manual Scratch Org Validation

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Select branch to validate (QA baseline is applied first)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa  # Added QA so you can select it from the UI
          - uat

jobs:
  validate-scratch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}
          path: current-branch

      - name: Checkout QA Baseline
        uses: actions/checkout@v4
        with:
          ref: qa
          path: qa-branch

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store \
            --alias DevHub_Git --sfdx-url-stdin --set-default-dev-hub

      - name: Create Scratch Org
        run: |
          # Use config from the branch you selected (even if it's qa)
          sf org create scratch \
            --definition-file current-branch/config/project-scratch-def.json \
            --target-dev-hub DevHub_Git \
            --alias ValidationOrg \
            --duration-days 1 --wait 20

      - name: Deploy QA Baseline
        run: |
          cd qa-branch
          sf project deploy start --target-org ValidationOrg --ignore-conflicts --wait 15

      - name: Deploy Selected Branch (Overlay)
        run: |
          # Go back to root, then into current-branch
          cd ../current-branch
          sf project deploy start --target-org ValidationOrg --ignore-conflicts --wait 15

      - name: Final Credentials for VS Code
        run: |
          sf org generate password --target-org ValidationOrg
          # Verbose output gives you the Sfdx Auth URL needed for VS Code
          sf org display --target-org ValidationOrg --verbose --json
