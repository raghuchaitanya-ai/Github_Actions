name: Provision Scratch Org for Dev

on:
  workflow_dispatch: # Manual trigger from GitHub UI

jobs:
  provision-org:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout QA Baseline
        uses: actions/checkout@v4
        with:
          ref: qa
          path: qa-baseline

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate DevHub
        run: |
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store \
            --alias DevHub_Git --sfdx-url-stdin --set-default-dev-hub

      - name: Create Scratch Org
        run: |
          # Uses the config file from the QA baseline
          sf org create scratch \
            --definition-file qa-baseline/config/project-scratch-def.json \
            --target-dev-hub DevHub_Git \
            --alias Dev_Validation_Org \
            --duration-days 1 --wait 20

      - name: Deploy QA Baseline Metadata
        run: |
          sf project deploy start \
            --source-dir $GITHUB_WORKSPACE/qa-baseline/force-app \
            --target-org Dev_Validation_Org \
            --ignore-conflicts \
            --wait 15

      - name: Generate Access Credentials
        run: |
          sf org generate password --target-org Dev_Validation_Org
          
          echo "--- ORG ACCESS DETAILS ---"
          sf org display --target-org Dev_Validation_Org
          
          echo "--- SFDX AUTH URL (Copy this to auth in VS Code) ---"
          sf org display --target-org Dev_Validation_Org --verbose --json | jq -r '.result.sfdxAuthUrl'