name: Manual Scratch Org Validation

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to use as basis (usually QA)'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - uat

jobs:
  create-and-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout QA Baseline
        uses: actions/checkout@v4
        with:
          ref: qa
          path: qa-branch

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate DevHub
        run: |
          # We store the URL and explicitly set it as the default DevHub for this session
          echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store \
            --alias DevHub_Git \
            --sfdx-url-stdin \
            --set-default-dev-hub

      - name: Create Scratch Org
        run: |
          # Explicitly calling the DevHub alias to prevent 'No Default Dev Hub' error
          sf org create scratch \
            --definition-file qa-branch/config/project-scratch-def.json \
            --alias ValidationOrg \
            --target-dev-hub DevHub_Git \
            --duration-days 1 \
            --wait 20

      - name: Deploy QA Baseline to Org
        run: |
          # Using the full path to force-app within the checked-out folder
          sf project deploy start \
            --source-dir qa-branch/force-app \
            --target-org ValidationOrg \
            --ignore-conflicts

      - name: Final Credentials for VS Code
        if: always()
        run: |
          # If the org was created successfully, this will show the login details
          sf org generate password --target-org ValidationOrg || echo "Org not found"
          echo "### Scratch Org Details" >> $GITHUB_STEP_SUMMARY
          sf org display --target-org ValidationOrg --verbose >> $GITHUB_STEP_SUMMARY || echo "Could not display org"
