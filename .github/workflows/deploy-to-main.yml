name: Deploy to Main

on:
  workflow_dispatch:

jobs:
  pmd-main:
    name: PMD Static Code Analysis (Main)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Install PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases/7.16.0/pmd-dist-7.16.0-bin.zip
          unzip pmd-dist-7.16.0-bin.zip
          mv pmd-bin-7.16.0 pmd

      - name: Run PMD Analysis
        run: |
          ./pmd/bin/pmd check \
            -d force-app/main/default/classes \
            -R rulesets/apex/quickstart.xml \
            -f text \
            -r pmd-report.txt \
            --no-fail-on-violation

      - name: Enforce PMD Quality Gate
        run: |
          violations=$(grep -c "^[^ ]" pmd-report.txt || true)
          echo "PMD Violations: $violations"
          if [ "$violations" -gt 5 ]; then
            echo "PMD Quality Gate Failed"
            exit 1
          fi

  apex-tests-main:
    name: Salesforce Apex Tests (Main)
    runs-on: ubuntu-latest
    needs: pmd-main

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to Production Org
        run: echo "${{ secrets.PROD_SF_AUTH_URL }}" | sf auth:sfdxurl:store --alias Production --sfdx-url-stdin

      - name: Run Apex Tests in Prod (if allowed)
        run: sf apex run test --target-org Production --result-format human --code-coverage --wait 10

  validation-main:
    name: Salesforce Validation (Main)
    runs-on: ubuntu-latest
    needs: apex-tests-main

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to DevHub
        run: echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" | sf auth:sfdxurl:store --alias DevHub --set-default-dev-hub --sfdx-url-stdin

      - name: Create Scratch Org for Main Validation
        run: sf org create scratch --definition-file config/project-scratch-def.json --alias MAIN_VALIDATION --set-default --duration-days 1 --target-dev-hub DevHub

      - name: Deploy to Scratch Org
        run: sf project deploy start --source-dir force-app --target-org MAIN_VALIDATION --test-level RunLocalTests --wait 10

      - name: Validate Deployment (CheckOnly)
        run: sf project deploy start --source-dir force-app --target-org MAIN_VALIDATION --dry-run --test-level RunLocalTests

      - name: Delete Scratch Org
        run: sf org delete scratch --target-org MAIN_VALIDATION --no-prompt || true

  deploy-main:
    name: Deploy to Main
    runs-on: ubuntu-latest
    needs: validation-main

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to Production Org
        run: echo "${{ secrets.PROD_SF_AUTH_URL }}" | sf auth:sfdxurl:store --alias Production --sfdx-url-stdin

      - name: Deploy Metadata to Production
        run: sf project deploy start --source-dir force-app/main/default --target-org Production --wait 10

  notify-main-failure:
    name: Failure Notification (Main)
    runs-on: ubuntu-latest
    needs:
      - pmd-main
      - apex-tests-main
      - validation-main
      - deploy-main
    if: ${{ failure() }}

    steps:
      - name: Send Failure Email Notification
        uses: Padmachilaka/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: " Main Deployment Pipeline Failed"
          to: padduja712@gmail.com
          from: ci-cd@yourcompany.com
          body: |
            The Main deployment pipeline failed.
            Please review the logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}